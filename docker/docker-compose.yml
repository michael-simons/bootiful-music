version: '3.7'

services:
  statsdb:
    image: bootiful-music/statsdb
    build: 
      context: statsdb
    environment:
      - POSTGRES_DB=bootiful-music
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD_FILE=/run/secrets/database_root_password
    volumes:
      - ./var/statsdb:/var/lib/postgresql/data
    secrets:
      - database_root_password
      - database_statsdb_password
    ports:
      - "5432:5432"
  knowledgedb:
      image: bootiful-music/knowledgedb
      build:
        context: knowledgedb
      environment:
        - NEO4J_AUTH_FILE=/run/secrets/knowledgedb_auth_file
        - EXTENSION_SCRIPT=/tmp/install-apoc.sh
        - NEO4J_dbms_memory_heap_initial__size=2G
        - NEO4J_dbms_memory_heap_max__size=2G
      volumes:
        - ./var/knowledgedb:/data
        - ./var/knowledgedb/plugins:/plugins
      secrets:
        - knowledgedb_auth_file
      ports:
        - "7474:7474"
        - "7687:7687"
      links:
        - statsdb

secrets:
  database_root_password:
    file: ./secrets/${PROFILE}/database_root_password
  database_statsdb_password:
    file: ./secrets/${PROFILE}/database_statsdb_password
  knowledgedb_auth_file:
    file: ./secrets/${PROFILE}/knowledgedb_auth_file